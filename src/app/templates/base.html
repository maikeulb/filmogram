<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    {% if title %}
      <title>{{ title }} - FilmoGram </title>
    {% else %}
      <title>Welcome to FilmoGram</title>
    {% endif %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/css/uikit.min.css" />
    {% if config.DEVELOPMENT %}
      <!-- Webpack Dev Mode -->
      <link rel="stylesheet" href="http://localhost:8080/static/css/app.css">
    {% else %}
      <!-- Static Build Mode -->
      <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/app.css') }}">
    {% endif %}
  </head>

  <body class="site">
    {% include '_navbar.html' %}

    {% block content %}
       <main class = "site-content">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <script>
              var messages = {{ messages | safe }};
              for (var i=0; i<messages.length; i++) {
                new Noty({
                  theme: 'rellax',
                  type: 'info',
                  text: messages[i]
                }).setTimeout(1000).show();
              } 
            </script>
          {% endif %}
        {% endwith %}
        {% block app_content %}{% endblock %}
      </main>
    {% endblock %}

    {% include '_footer.html' %}

    {% if config.DEVELOPMENT %}
      <!-- Webpack Dev Mode -->
      <script src='http://localhost:8080/static/js/app.bundle.js'></script>
    {% else %}
      <!-- Static Build Mode -->
      <script src='/static/js/app.bundle.js'></script>
    {% endif %}

    {% block scripts %}
      {{ moment.include_moment() }}
  	  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
      <script src="https://unpkg.com/infinite-scroll@3/dist/infinite-scroll.pkgd.js"></script>
      <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/js/uikit.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/js/uikit-icons.min.js"></script>
      <script>
        function set_user_notification_count(n) {
          $('#user_notification_count').data('badge',n);
          $('#user_notification_count').css('visibility', n ? 'visible' : 'hidden');
        }
        {% if current_user.is_authenticated %}
        $(function() {
          var since = 0;
          setInterval(function() {
            $.ajax('{{ url_for('api.get_notifications') }}?since=' + since).done(
              function(notifications) {
                for (var i = 0; i < notifications.length; i++) {
                  if (notifications[i].name == 'unread_user_notification_count')
                    set_user_notification_count(notifications[i].data);
                  since = notifications[i].timestamp;
                }
              }
            );
          }, 10000);
        });
        {% endif %}
      </script>

      <script type="text/javascript">
        $(document).ready(function () {
          var csrf_token = "{{ csrf_token() }}";
          $.ajaxSetup({
            beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
              }
            }
          });
        });
      </script>

      <script>
        $(function(){
          $('.nav-sub-toggle').on('click', function(){
            if ($(this).next('.uk-nav-sub').hasClass('closed')) {
              $(this).removeClass('uk-icon-chevron-right').addClass('uk-icon-chevron-down');
              $(this).next('.uk-nav-sub').removeClass('closed');
            } else {
              $(this).removeClass('uk-icon-chevron-down').addClass('uk-icon-chevron-right');
              $(this).next('.uk-offcanvas-bar .uk-parent .uk-nav-sub').addClass('closed');
            }
          });
          });
      </script>

      <script>
      $(document).ready(function() {
        $(".uk-navbar-nav a").on("click", function(){
           $(".uk-navbar-nav").find(".uk-active").removeClass("uk-active");
           $(this).parent('li').addClass("uk-active");
         });
      });
      </script>

      <script>
        $(document).ready(function () {
          $('#user_notification_count').on("click", resetCount);

          function resetCount (e) {
            e.preventDefault();
              reset(done, fail);
          };
           function done(data) {
             $('#user_notification_count').hide(500).css({visibility: 'hidden',display: ""});
          };
           function fail() {
              alert("Something failed");
          };
          function reset(done, fail) {
            $.ajax({
               url: "/api/notifications",
               method: "DELETE",
             })
               .done(done)
               .fail(fail);
          };
      });
      </script>

    {% endblock %}
    {% block js %}{% endblock %}

  </body>
</html>
