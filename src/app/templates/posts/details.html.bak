{% extends "base.html" %}

{% block app_content %}

  <table class = "ui celled padded table">
    <thead>
    <tr>
    <th class="single line">
      <img class="ui avatar image" src="{{ post.author.profile_img_url or
        post.author.avatar(70) }}"
        height="70px" />
      <span>
        {% set user_link %}
        <a href="{{ url_for('user.profile', username=post.author.username) }}">
          {{ post.author.username }}
        </a>
        {% endset %}
        {{ user_link }} said {{ moment(post.timestamp).fromNow() }}
        <br>
      </span>
    </th>
    </tr>
    </thead>
    <tbody>
      <tr>
      <td>
        <img id="post{{ post.id }}" src={{ post.photo_url }} height="400px">
        <br><br>
        {% if current_user.has_liked(post) %}
        <p><a class = "unlike_post{{ post.id }}" href="{{ url_for('api.unlike', id=post.id) }}">UnLike</a></p>
        {% else %}
        <p><a class = "like_post{{ post.id }}" href="{{ url_for('api.like', id=post.id) }}"> Like</a></p>
        {% endif %}
        {% for like in post['likes'] %} {{ like.username }} {% endfor %}
        <form role="form" id="like-post{{ post.id }}">
          <div class="form-group">
            <button id="like-send" type="submit" class="btn btn-primary">Like</button>
          </div>
        </form>
      </td>
      </tr>
    </tbody>
  </table>

  <div class="comment form">
    <h2>Leave a Comment</h2> 
    <form  data-post-id="{{post.id}}" action="{{ url_for('posts.details', id=post.id) }}" method="POST">
      {{ form.hidden_tag() }}
        <div class="field">
          {{ form.body.label }}
          {{ form.body}}
        </div>
      {{ form.submit }}
      {% for error in form.body.errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </form>
  </div>

  {% include 'explore/_comments.html' %}
{% endblock %}

{% block js %}
  <script>
      $(document).ready(function() {
        $('form[data-post-id="{{ post.id }}"]').submit(function (e) {
          alert(JSON.stringify($('form[data-post-id="{{post.id}}"]').serialize()));
              $.ajax({
                  type: "POST",
                  url: "{{ url_for('api.comment', id=post.id) }}",
                data: $('form[data-post-id="{{ post.id }}"]').serialize(),
                  success: function (data) {
                     alert(JSON.stringify(data));
                     $('#comments[data-post-id="{{ post.id }}"]').append(" " +data.data)
                  },
                  error: function(xhr, ajaxOptions, thrownError){
                   alert('not_cool') 
                  },
              });
              e.preventDefault(); // block the traditional submission of the form.
          });
          $.ajaxSetup({
              beforeSend: function(xhr, settings) {
                  if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                      xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
                  }
              }
          })
      });
  </script>
{% endblock %}
