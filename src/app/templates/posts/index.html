{% extends "base.html" %}

{% block app_content %}
<main class="mui--text-center">
<h1 class="uk-heading-line"><span>Photos</span></h1>
  <div>
    {% include 'posts/_posts.html' %}
    {% if next_url %}
      <a class="npage" hidden href={{ next_url or "#" }}>next_url</a>
    {% endif %}
  </div>
</main>

{% endblock %}

{% block js %}

<script type="text/javascript">
  $(document).ready(function () {
    var csrf_token = "{{ csrf_token() }}";
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrf_token);
        }
      }
    });
  });
</script>

<script>
  $('.container').infiniteScroll({
    path: '.npage',
    append: '.post-item'
  });
</script>

<script>
  $(document).ready(function () {
    $('#posts').on("click", '.js-toggle-like', toggleLike);
    var button;
    var postId;

    function toggleLike (e) {
      e.preventDefault();
      button = $(e.target);
      postId = button.data("post-id");

      if (button.hasClass("uk-button-default"))
        likePost(postId, like_cb, fail);
      else
        unlikePost(postId, unlike_cb, fail);
    };
     function like_cb(data) {
        button.toggleClass("uk-button-default").toggleClass("uk-button-primary")
       $("#likes[data-post-id=" + postId +"]").append("<a class='uk-link-text' href='/user/" + data.result + "'>" + data.result + "</a>&nbsp;");
    };
     function unlike_cb(data) {
        button.toggleClass("uk-button-default").toggleClass("uk-button-primary")
        $("#likes[data-post-id=" + postId +"]:last a").remove();
    };
     function fail() {
        alert("Something failed");
    };
    function likePost(postId, done, fail) {
      $.ajax({
         url: "/api/like/" + postId,
         method: "POST",
       })
         .done(like_cb)
         .fail(fail);
    };
    function unlikePost(postId, done, fail) {
      $.ajax({
         url: "/api/like/" + postId,
         method: "DELETE",
       })
         .done(unlike_cb)
         .fail(fail);
    };
  });
</script>

{% endblock %}
